# WhatsApp Meta API Integration - Complete Implementation Guide

## 1. Webhook Verification

```javascript
// GET /webhooks/whatsapp - Meta webhook verification
app.get('/webhooks/whatsapp', (req, res) => {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];
  
  if (mode === 'subscribe' && token === process.env.WEBHOOK_VERIFY_TOKEN) {
    console.log('Webhook verified successfully');
    res.status(200).send(challenge);
  } else {
    console.log('Webhook verification failed');
    res.status(403).send('Forbidden');
  }
});
```

**What we return:** Just the `challenge` string that Meta sends us. That's it - no JSON, no extra data.

## 2. Database Session Tracking

```javascript
// Track session state in event_log table
const checkSessionState = async (phoneNumber) => {
  // Look for last message from this user within 24 hours
  const sessionCheck = await query(`
    SELECT 
      MAX(created_at) as last_message_at,
      COUNT(*) as message_count
    FROM event_log 
    WHERE event_type = 'whatsapp_message_received'
      AND metadata->>'from' = $1
      AND created_at > NOW() - INTERVAL '24 hours'
  `, [phoneNumber]);
  
  const lastMessage = sessionCheck.rows[0];
  
  // If no messages in 24 hours, user is outside session window
  if (!lastMessage.last_message_at) {
    return { inSession: false, reason: 'no_recent_messages' };
  }
  
  return { inSession: true, lastMessageAt: lastMessage.last_message_at };
};

// Usage in message handler
const sessionState = await checkSessionState(fromNumber);
if (!sessionState.inSession) {
  // Send template message
  return await sendTemplateMessage(fromNumber, 'welcome_template');
}
```

**Table structure:** We use the existing `event_log` table with `event_type = 'whatsapp_message_received'` and store the `from` phone number in metadata JSON.

## 3. Error 131047 Specific Handling

```javascript
const sendMessageWithFallback = async (to, message) => {
  try {
    const result = await sendTextMessage({ to, text: message });
    return result;
  } catch (error) {
    if (error.message.includes('131047') || error.message.includes('Re-engagement')) {
      console.log('Session expired, sending template message');
      // Send approved template message
      return await sendTemplateMessage(to, 'growthpoint_emergency_response');
    }
    throw error;
  }
};

const sendTemplateMessage = async (to, templateName) => {
  const payload = {
    messaging_product: "whatsapp",
    to: to,
    type: "template",
    template: {
      name: templateName,
      language: { code: "en" }
    }
  };
  
  const res = await fetch(`https://graph.facebook.com/v23.0/${phoneNumberId}/messages`, {
    method: "POST",
    headers: { 
      "Content-Type": "application/json", 
      "Authorization": `Bearer ${accessToken}` 
    },
    body: JSON.stringify(payload)
  });
  
  return await res.json();
};
```

**Template used:** `growthpoint_emergency_response` - this must be pre-approved in Meta Business Manager.

## 4. Complete Working Flow

```javascript
const handleIncomingMessage = async (req, res) => {
  try {
    const body = req.body;
    
    // Extract message data
    const entry = body.entry[0];
    const changes = entry.changes[0];
    const value = changes.value;
    
    if (!value.messages) {
      return res.status(200).send('OK');
    }
    
    const message = value.messages[0];
    const fromNumber = message.from;
    const messageText = message.text?.body || '';
    const messageType = message.type;
    
    console.log(`Received ${messageType} from ${fromNumber}: ${messageText}`);
    
    // Log the incoming message
    await query(`
      INSERT INTO event_log (event_type, metadata, created_at)
      VALUES ($1, $2, NOW())
    `, ['whatsapp_message_received', JSON.stringify({
      from: fromNumber,
      type: messageType,
      text: messageText,
      messageId: message.id
    })]);
    
    // Check session state
    const sessionState = await checkSessionState(fromNumber);
    
    if (!sessionState.inSession) {
      // Outside 24-hour window - send template
      await sendTemplateMessage(fromNumber, 'growthpoint_emergency_response');
      return res.status(200).send('OK');
    }
    
    // Inside session window - process normally
    if (messageType === 'text' && messageText.toLowerCase() === 'hi') {
      await sendMessageWithFallback(fromNumber, 'Hello! How can I help you today?');
    }
    
    res.status(200).send('OK');
    
  } catch (error) {
    console.error('Error handling message:', error);
    res.status(500).send('Error');
  }
};
```

## 5. Phone Number Normalization

```javascript
const normalizePhoneNumber = (phoneNumber) => {
  // Remove + symbol and any spaces
  let normalized = phoneNumber.replace(/^\+/, '').replace(/\s/g, '');
  
  // Ensure it starts with country code (27 for South Africa)
  if (normalized.startsWith('0')) {
    normalized = '27' + normalized.substring(1);
  } else if (!normalized.startsWith('27')) {
    normalized = '27' + normalized;
  }
  
  return normalized;
};

// Usage in webhook handler
const fromNumber = normalizePhoneNumber(message.from);
```

**Format:** Always remove + symbol, ensure country code 27 prefix, no spaces.

## 6. Template Names

```javascript
const TEMPLATES = {
  WELCOME: 'growthpoint_emergency_response',
  EMERGENCY: 'growthpoint_lift_emergency',
  MAINTENANCE: 'growthpoint_maintenance_request'
};

// These templates must be:
// 1. Created in Meta Business Manager
// 2. Approved by Meta
// 3. Associated with your WhatsApp Business Account
```

**Pre-approved templates:** Yes, all templates must be approved in Meta Business Manager before use. The `growthpoint_emergency_response` template is our main greeting template.

## Key Points for Implementation:

1. **Always check session state** before sending free-form messages
2. **Handle 131047 errors** with automatic template fallback
3. **Normalize phone numbers** to remove + and ensure country code
4. **Log everything** in event_log for session tracking
5. **Use approved templates** for out-of-session messages

This is the exact pattern that works reliably with Meta's WhatsApp Business API!
